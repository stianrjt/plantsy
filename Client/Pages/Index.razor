@page "/"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Plantsy.Shared
@attribute [Authorize]
@inject HttpClient Http




@if (plants == null)
{
	<MudSkeleton />
	<MudSkeleton SkeletonType="SkeletonType.Circle" Width="50px" Height="50px" />
	<MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="200px" Height="110px" />
}
else
{
	<MudGrid>
		<MudItem Style="background-color: transparent; border: hidden; elevation: unset" xs="12" md="12">
			<MudPaper Style="background-color:transparent; border: hidden; elevation: unset" Class="d-flex flex-wrap flex-wrap py-2 px-1">
				@foreach (var plant in plants)
				{
					var link = $"editPlant/{plant.ID.ToString()}";

					<MudCard  Style="width:200px" Elevation="3" Class="ma-2">
						<MudCardMedia  Image="Strelitzia-reginae-1.jpg" Style="border-radius:2%; width:200px" Height="200" />
						<MudCardHeader>
							<CardHeaderContent>
								<MudText Typo="Typo.h6">@plant.PlantName</MudText>
							</CardHeaderContent>
							<CardHeaderActions>
								<link href="https://use.fontawesome.com/releases/v5.14.0/css/all.css" rel="stylesheet">
								@if ((DateTimeOffset.Now - plant.LastWatered).Days < 5)
								{
									<MudIconButton Icon="fas fa-tint " Style="Color: green"  Size="Size.Small"
												   OnClick="@(() => WaterPlant(plant))" />
								}
								else if ((DateTimeOffset.Now - plant.LastWatered).Days < 7)
								{

									<MudIconButton Icon="fas fa-tint " Style="Color: yellow"  Size="Size.Small"
												   OnClick="@(() => WaterPlant(plant))" />

								}
								else
								{
									<MudIconButton Icon="fas fa-tint " Style="Color: red"  Size="Size.Small"
												   OnClick="@(() => WaterPlant(plant))" />
								}
							</CardHeaderActions>
						</MudCardHeader>
						<MudCardContent>
							<MudText Typo="Typo.body2">@plant.Info</MudText>
						</MudCardContent>
						<MudCardActions>
							<MudLink Href="@link">
								<MudButton Variant="Variant.Text" Color="Color.Secondary" Style="bottom: 10px; margin: 5px">Edit Plant</MudButton>
							</MudLink>
						</MudCardActions>
					</MudCard>


				}

			</MudPaper>
		</MudItem>
	</MudGrid>
}



@code {
	private List<Plant> plants;
	private bool _hidePosition;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			plants = await Http.GetFromJsonAsync<List<Plant>>("plants");
		}
		catch (AccessTokenNotAvailableException exception)
		{
			exception.Redirect();
		}
	}

	public async void WaterPlant(Plant plant)
	{
		var waterLog = plant.WaterLog;
		waterLog.Add(new Water { WaterDate = DateTimeOffset.Now, });
		plant.WaterLog = waterLog;
		plant.LastWatered = DateTimeOffset.Now;
		await Http.PutAsJsonAsync($"plants/{plant.ID}", plant);
		return;
	}

}